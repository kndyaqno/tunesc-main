<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Playlist Generator</title>
    <!-- Include the Spotify Web API script -->
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }

        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 10px;
            cursor: pointer;
        }

        input[type="range"] {
            width: 80%;
            margin-top: 10px;
        }

        /* Styles for the modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
            text-align: left;
        }
    </style>
</head>
<body>
    <!-- Connect to Spotify button -->
    <button id="connectBtn" onclick="authenticateSpotify()">Connect to Spotify</button>

    <!-- Generate Playlist buttons -->
    <button class="emoji-button" onclick="showModal('üòä')">üòä</button>
    <button class="emoji-button" onclick="showModal('üò¢')">üò¢</button>
    <button class="emoji-button" onclick="showModal('üòé')">üòé</button>
    <button class="emoji-button" onclick="showModal('üò¥')">üò¥</button>
    <button class="emoji-button" onclick="showModal('‚ù§Ô∏è')">‚ù§Ô∏è</button>

    <!-- Modal for adjusting settings -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <label for="numSongsRange">Number of Songs:</label>
            <br>
            <input type="range" id="numSongsRange" min="1" max="50" value="30">
            <br>
            <span id="numSongsValue">30</span>
            <br>
            <label for="imageInput">Upload Image:</label>
            <input type="file" id="imageInput" accept="image/*">
            <br>
            <button onclick="generateRandomPlaylist()">Generate Playlist</button>
            <button onclick="hideModal()">Cancel</button>
        </div>
    </div>

<script>
    // Spotify API credentials
    const clientId = 'd4755119e396499d85fab5db2e5f8a8a';
    const clientSecret = 'fcaecd1ac01640a1adad2a2c30d5b783';
    const redirectUri = 'http://127.0.0.1:5500/tunesc-vs/pages/test.html'; // Update this to your server endpoint

    // Spotify access token
    let accessToken;

    // Function to authenticate with Spotify using Authorization Code flow
    function authenticateSpotify() {
        const scopes = 'playlist-modify-public'; // Add any additional scopes your app needs

        // Redirect the user to Spotify for authentication
        window.location.href = `https://accounts.spotify.com/authorize?client_id=${clientId}&redirect_uri=${redirectUri}&scope=${encodeURIComponent(scopes)}&response_type=code`;
    }

    // Function to extract the authorization code from the URL after the redirect
    function getAuthorizationCode() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('code');
    }

    // Check if the page was redirected from Spotify with an authorization code
    const authorizationCode = getAuthorizationCode();
    if (authorizationCode) {
        // Exchange the authorization code for an access token
        exchangeAuthorizationCode(authorizationCode);
    }

    // Function to exchange the authorization code for an access token
    function exchangeAuthorizationCode(code) {
        const tokenEndpoint = 'https://accounts.spotify.com/api/token';
        const data = {
            grant_type: 'authorization_code',
            code: code,
            redirect_uri: redirectUri,
            client_id: clientId,
            client_secret: clientSecret,
        };

        fetch(tokenEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(data)
        })
        .then(response => response.json())
        .then(data => {
            accessToken = data.access_token;
            document.getElementById('generateBtn').disabled = false;
            alert('Connected to Spotify!');
        })
        .catch(error => {
            console.error('Error exchanging authorization code:', error);
        });
    }

    // Spotify SDK Initialization
    window.onSpotifyWebPlaybackSDKReady = () => {
        // SDK is ready, you can add SDK-related code here
    };

    // Function to generate a playlist of random songs based on settings
    function generateRandomPlaylist() {
        if (!accessToken) {
            alert('Please connect to Spotify first.');
            hideModal();
            return;
        }

        const numSongs = document.getElementById('numSongsRange').value;
        const imageFile = document.getElementById('imageInput').files[0];

        // Example: Create a playlist named "Random Playlist" with numSongs random songs and an optional image
        createPlaylist('Random Playlist', imageFile).then(playlistId => {
            generateRandomTracks(numSongs).then(trackUris => {
                addTracksToPlaylist(playlistId, trackUris).then(() => {
                    alert(`Playlist "Random Playlist" created with ${numSongs} random songs.`);
                    hideModal();
                });
            });
        });
    }

    // Function to create a playlist in the user's Spotify account with an optional image
    async function createPlaylist(playlistName, imageFile) {
        const createPlaylistEndpoint = 'https://api.spotify.com/v1/me/playlists';

        // Create the playlist
        const response = await fetch(createPlaylistEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                name: playlistName,
                public: true
            })
        });

        const data = await response.json();
        const playlistId = data.id;

        // Upload image if provided
        if (imageFile) {
            await uploadPlaylistImage(playlistId, imageFile);
        }

        return playlistId;
    }

    // Function to upload an image to a playlist
    async function uploadPlaylistImage(playlistId, imageFile) {
        const uploadImageEndpoint = `https://api.spotify.com/v1/playlists/${playlistId}/images`;

        // Create a FormData object and append the image file
        const formData = new FormData();
        formData.append('image', imageFile);

        // Upload the image
        await fetch(uploadImageEndpoint, {
            method: 'PUT',
            headers: {
                'Authorization': `Bearer ${accessToken}`
            },
            body: formData
        });
    }

    // Function to generate a list of random song track URIs
    async function generateRandomTracks(numTracks) {
        const randomTracksEndpoint = 'https://api.spotify.com/v1/browse/new-releases';
        const response = await fetch(randomTracksEndpoint, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });

        const data = await response.json();
        const trackUris = data.albums.items.slice(0, numTracks).map(item => item.uri);
        return trackUris;
    }

    // Function to add tracks to a playlist
    async function addTracksToPlaylist(playlistId, trackUris) {
        const addTracksEndpoint = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;

        await fetch(addTracksEndpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            },
            body: JSON.stringify({
                uris: trackUris
            })
        });
    }

    // Function to show the modal and set default values
    function showModal(emoji) {
        const modal = document.getElementById('myModal');
        modal.style.display = 'flex';

        // Set emoji for the playlist
        document.getElementById('emojiPlaceholder').innerText = emoji;

        // Set default value for the number of songs
        document.getElementById('numSongsRange').value = 30;
        document.getElementById('numSongsValue').innerText = '30';

        // Clear the image input value
        document.getElementById('imageInput').value = '';
    }

    // Function to hide the modal
    function hideModal() {
        const modal = document.getElementById('myModal');
        modal.style.display = 'none';
    }

    // Update the displayed value when the range input changes
    document.getElementById('numSongsRange').addEventListener('input', function() {
        document.getElementById('numSongsValue').innerText = this.value;
    });
</script>
</body>
</html>
